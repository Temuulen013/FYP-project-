<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SecureVote | Official Election Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --accent: #3b82f6;
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 12px;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      nav {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-weight: 800;
        font-size: 1.5rem;
        color: var(--primary-dark);
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-items {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .user-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f1f5f9;
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-main);
      }
      .btn-logout {
        background: transparent;
        border: 1px solid #cbd5e1;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text-muted);
        transition: 0.2s;
      }
      .btn-logout:hover {
        border-color: var(--danger);
        color: var(--danger);
        background: #fef2f2;
      }

      .auth-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .auth-card {
        background: var(--bg-card);
        padding: 40px;
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 420px;
        text-align: center;
        border: 1px solid #f1f5f9;
      }
      .auth-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        background: #eff6ff;
        width: 80px;
        height: 80px;
        line-height: 80px;
        border-radius: 50%;
        margin: 0 auto 20px;
      }
      .input-group {
        text-align: left;
        margin-bottom: 15px;
      }
      .input-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-muted);
      }
      input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: 0.2s;
        box-sizing: border-box;
        font-family: inherit;
      }
      input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.2s;
        margin-top: 10px;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      .btn-primary:active {
        transform: translateY(0);
      }
      .link {
        margin-top: 20px;
        display: block;
        font-size: 0.9rem;
        color: var(--primary);
        cursor: pointer;
        font-weight: 500;
      }
      .link:hover {
        text-decoration: underline;
      }

      .container {
        max-width: 1100px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .section-header {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: end;
      }
      .section-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-main);
      }
      .status-pill {
        font-size: 0.9rem;
        font-weight: 700;
        padding: 6px 12px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .status-live {
        background: #dcfce7;
        color: #15803d;
      }
      .status-stopped {
        background: #f1f5f9;
        color: #64748b;
      }

      .ballot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }
      .candidate-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid #f1f5f9;
        box-shadow: var(--shadow-sm);
        transition: 0.3s;
        display: flex;
        flex-direction: column;
      }
      .candidate-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: #e2e8f0;
      }
      .card-img-wrap {
        height: 180px;
        background: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }
      .candidate-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card-body {
        padding: 25px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        text-align: center;
      }
      .card-body h3 {
        margin: 0 0 10px 0;
        font-size: 1.4rem;
        color: var(--text-main);
      }
      .card-body p {
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 20px;
        flex-grow: 1;
      }

      .btn-vote {
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        font-weight: 700;
        padding: 10px;
        border-radius: 50px;
        cursor: pointer;
        transition: 0.2s;
        width: 100%;
      }
      .btn-vote:hover {
        background: var(--primary);
        color: white;
      }
      .btn-vote:disabled {
        border-color: #e2e8f0;
        color: #cbd5e1;
        cursor: not-allowed;
        background: #f8fafc;
      }

      .winner-box {
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        border: 2px solid #bfdbfe;
        border-radius: 24px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.1);
        margin-bottom: 40px;
        animation: popIn 0.5s ease-out;
      }
      @keyframes popIn {
        0% {
          transform: scale(0.9);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .audit-terminal {
        background: #0f172a;
        border-radius: 16px;
        padding: 25px;
        color: #38bdf8;
        font-family: 'Courier New', monospace;
        margin-top: 50px;
        border: 1px solid #1e293b;
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
      }
      .audit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #1e293b;
        padding-bottom: 15px;
        margin-bottom: 15px;
      }
      .audit-log {
        height: 200px;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse;
        gap: 8px;
        font-size: 0.9rem;
      }
      .log-entry {
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      #toast {
        visibility: hidden;
        background-color: #1e293b;
        color: #fff;
        text-align: center;
        border-radius: 50px;
        padding: 12px 30px;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 500;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }
      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="authView" class="auth-wrapper">
      <div class="auth-card">
        <div class="auth-icon">üó≥Ô∏è</div>

        <div id="loginForm">
          <h2 style="margin-top: 0">Welcome Back</h2>
          <p style="color: var(--text-muted); margin-bottom: 30px">
            Secure Blockchain Voting System
          </p>
          <button class="btn-primary" onclick="login()">
            üöÄ Connect Wallet & Login
          </button>
          <span class="link" onclick="switchMode('register')"
            >New Voter? Create Account</span
          >
        </div>

        <div id="registerForm" style="display: none">
          <h2 style="margin-top: 0">Voter Registration</h2>
          <p style="color: var(--text-muted); margin-bottom: 20px">
            Enter your official details below.
          </p>

          <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="regName" placeholder="e.g. Tsengel" />
          </div>
          <div class="input-group">
            <label>Government ID / Passport</label>
            <input type="text" id="regId" placeholder="e.g. ID-8842" />
          </div>

          <button class="btn-primary" onclick="register()">
            ‚úÖ Register & Sign In
          </button>
          <span class="link" onclick="switchMode('login')"
            >Already have an account? Login</span
          >
        </div>
      </div>
    </div>

    <div id="dashboardView" style="display: none">
      <nav>
        <div class="logo">
          üó≥Ô∏è Mongolian Blockchain Based Electorial System
          <span
            style="
              font-size: 0.7rem;
              background: #eff6ff;
              color: var(--primary);
              padding: 2px 8px;
              border-radius: 4px;
            "
            >local</span
          >
        </div>
        <div class="nav-items">
          <span id="userNameDisplay" class="user-badge">...</span>
          <a
            id="adminLink"
            href="admin.html"
            style="display: none; text-decoration: none"
          >
            <button
              style="
                background: var(--primary);
                color: white;
                border: none;
                padding: 6px 15px;
                border-radius: 50px;
                font-weight: 600;
                cursor: pointer;
              "
            >
              üîí Admin
            </button>
          </a>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </nav>

      <div class="container">
        <div class="section-header">
          <div>
            <h2
              style="
                font-size: 1rem;
                text-transform: uppercase;
                color: var(--text-muted);
                letter-spacing: 1px;
                margin-bottom: 5px;
              "
            >
              Election Status
            </h2>
            <div
              id="statusText"
              style="font-size: 2rem; font-weight: 800; color: var(--text-main)"
            >
              Checking...
            </div>
          </div>
          <div id="liveIndicator" class="status-pill status-stopped">
            ‚óè Offline
          </div>
        </div>

        <div id="winnerSection" class="winner-box" style="display: none">
          <div style="font-size: 5rem; margin-bottom: 10px">üëë</div>
          <h2
            style="
              color: #64748b;
              text-transform: uppercase;
              letter-spacing: 2px;
              font-size: 1rem;
              margin: 0;
            "
          >
            Official Winner
          </h2>
          <h1
            id="winnerName"
            style="
              color: var(--primary-dark);
              font-size: 3.5rem;
              margin: 10px 0;
              font-weight: 800;
            "
          >
            ...
          </h1>
          <p
            id="winnerBio"
            style="
              font-size: 1.2rem;
              color: #475569;
              max-width: 600px;
              margin: 0 auto 30px;
            "
          >
            ...
          </p>
          <div id="winnerBtnContainer"></div>
        </div>

        <div id="ballotList" class="ballot-grid"></div>

        <div id="publicAuditLog" class="audit-terminal" style="display: none">
          <div class="audit-header">
            <span style="font-weight: bold">üìú FINAL BLOCKCHAIN LEDGER</span>
            <span style="font-size: 0.8rem; color: #94a3b8"
              >IMMUTABLE RECORD</span
            >
          </div>
          <div id="publicLogBox" class="audit-log">
            <div>Loading immutable history...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast">Message</div>

    <script>
      let contractAddress;
      let contractABI;
      let contract;

      let signer;
      async function login() {
        const jsonUrl = './Voting.json';

        try {
          const response = await fetch(jsonUrl);
          if (!response.ok) throw new Error('Could not find Voting.json');

          const data = await response.json();
          const contractAddress = data.address;
          const contractABI = data.abi;

          if (!window.ethereum) return alert('Please install MetaMask');

          const provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);

          console.log('Connected to contract at:', contractAddress);
        } catch (error) {
          console.error('Connection Error:', error);
          alert('Connection failed: ' + error.message);
        }
      }

      async function init() {
        const response = await fetch('./Voting.json');
        const data = await response.json();
        const newAddress = data.address;

        const savedAddress = localStorage.getItem('lastContractAddress');

        if (savedAddress !== newAddress) {
          console.log(
            'üöÄ New Blockchain detected! Wiping old browser cache...'
          );
          localStorage.clear();
          localStorage.setItem('lastContractAddress', newAddress);
          location.reload();
          return;
        }
      }

      window.onload = init;
      function resetSystemData() {
        console.log('üîÑ Reset process started...');

        try {
          localStorage.clear();
          console.log('‚úÖ LocalStorage cleared.');

          sessionStorage.clear();
          console.log('‚úÖ SessionStorage cleared.');

          document.cookie.split(';').forEach(function (c) {
            document.cookie = c
              .replace(/^ +/, '')
              .replace(
                /=.*/,
                '=;expires=' + new Date().toUTCString() + ';path=/'
              );
          });
          console.log('‚úÖ Cookies cleared.');

          alert('System Data Reset! Your browser memory is now clean.');

          window.location.href = window.location.pathname + '?t=' + Date.now();
        } catch (e) {
          console.error('‚ùå Reset failed:', e);
          alert('Reset Error: ' + e.message);
        }
      }

      function switchMode(mode) {
        document.getElementById('loginForm').style.display =
          mode === 'register' ? 'none' : 'block';
        document.getElementById('registerForm').style.display =
          mode === 'register' ? 'block' : 'none';
      }

      async function connectWallet() {
        if (!window.ethereum) return alert('Install MetaMask');
        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const res = await fetch('./Voting.json');
        const data = await res.json();
        contract = new ethers.Contract(data.address, data.abi, signer);
        return await signer.getAddress();
      }

      async function login() {
        try {
          const addr = await connectWallet();
          const owner = await contract.electionCommission();
          if (owner.toLowerCase() === addr.toLowerCase()) {
            saveSession('Administrator', addr);
            showDashboard('Administrator', addr);
            return;
          }
          const profile = await contract.getMyProfile();
          if (profile[0] === true) {
            saveSession(profile[2], addr);
            showDashboard(profile[2], addr);
          } else {
            showToast('‚ùå Account not found. Please Register.');
            switchMode('register');
          }
        } catch (e) {
          console.error(e);
          showToast('Connection failed');
        }
      }

      async function register() {
        const name = document.getElementById('regName').value;
        const id = document.getElementById('regId').value;
        if (!name || !id) return showToast('Please fill all fields');
        try {
          await connectWallet();
          const tx = await contract.registerUser(name, id);
          showToast('Creating Account...');
          await tx.wait();
          showToast('‚úÖ Registration Successful!');
          saveSession(name, await signer.getAddress());
          showDashboard(name, await signer.getAddress());
        } catch (e) {
          showToast('Error: ' + (e.reason || 'ID might be used'));
        }
      }

      function saveSession(name, address) {
        localStorage.setItem('userSession', JSON.stringify({ name, address }));
      }

      function logout() {
        localStorage.removeItem('userSession');
        location.reload();
      }

      function showDashboard(name, addr) {
        document.getElementById('authView').style.display = 'none';
        document.getElementById('dashboardView').style.display = 'block';
        document.getElementById('userNameDisplay').innerText = 'üë§ ' + name;
        checkAdmin(addr);
        loadDashboardData();
      }

      async function loadDashboardData() {
        if (!contract) await connectWallet();
        const state = await contract.getElectionState();
        const isStarted = state[0];
        const isEnded = state[1];

        const statusText = document.getElementById('statusText');
        const indicator = document.getElementById('liveIndicator');

        if (isEnded) {
          document.getElementById('winnerSection').style.display = 'block';
          document.getElementById('ballotList').style.display = 'none';
          document.getElementById('publicAuditLog').style.display = 'block';
          statusText.innerText = 'Results Finalized';
          indicator.className = 'status-pill status-stopped';
          indicator.innerText = '‚óè Ended';
          loadPublicAuditHistory();
          calculateWinner();
        } else {
          document.getElementById('winnerSection').style.display = 'none';
          document.getElementById('publicAuditLog').style.display = 'none';
          document.getElementById('ballotList').style.display = 'grid';
          statusText.innerText = isStarted
            ? 'Voting In Progress'
            : 'Waiting to Start';
          indicator.className = isStarted
            ? 'status-pill status-live'
            : 'status-pill status-stopped';
          indicator.innerText = isStarted ? '‚óè Live' : '‚óè Offline';
          renderBallot(isStarted);
        }
      }

      async function renderBallot(isStarted) {
        const data = await contract.getAllCandidates();
        const names = data[0];
        const photos = data[1];
        const bios = data[2];
        const list = document.getElementById('ballotList');
        list.innerHTML = '';
        if (names.length === 0)
          list.innerHTML = "<p style='color:gray'>No candidates yet.</p>";

        names.forEach((name, i) => {
          let imgHtml = photos[i]
            ? `<img src="${photos[i]}" class="candidate-img">`
            : `<span style='font-size:2rem'>üë§</span>`;
          const div = document.createElement('div');
          div.className = 'candidate-card';
          div.innerHTML = `
                      <div class="card-img-wrap">${imgHtml}</div>
                      <div class="card-body">
                          <h3>${name}</h3>
                          <p>${bios[i] || ''}</p>
                          <button class="btn-vote" onclick="vote(${i})" ${
            !isStarted ? 'disabled' : ''
          }>VOTE NOW</button>
                      </div>
                  `;
          list.appendChild(div);
        });
      }

      async function vote(index) {
        try {
          const tx = await contract.vote(index);
          showToast('Confirming Vote...');
          await tx.wait();
          showToast('Vote Cast! üéâ');
        } catch (e) {
          showToast('Error: ' + (e.reason || 'Check status'));
        }
      }

      async function calculateWinner() {
        const data = await contract.getAllCandidates();
        const names = data[0];
        const counts = data[3];
        let max = -1;
        let winnerIdx = -1;
        for (let i = 0; i < counts.length; i++) {
          if (Number(counts[i]) > max) {
            max = Number(counts[i]);
            winnerIdx = i;
          }
        }
        if (winnerIdx > -1) {
          const winnerData = {
            name: names[winnerIdx],
            photo: data[1][winnerIdx],
            bio: data[2][winnerIdx],
            votes: Number(counts[winnerIdx]),
          };
          localStorage.setItem('winnerData', JSON.stringify(winnerData));
          document.getElementById('winnerName').innerText = names[winnerIdx];
          document.getElementById('winnerBio').innerText = data[2][winnerIdx];
          document.getElementById(
            'winnerBtnContainer'
          ).innerHTML = `<button class="btn-primary" onclick="window.location.href='president.html'" style="max-width:300px;">üìÑ View Official President Profile</button>`;
        }
      }

      async function loadPublicAuditHistory() {
        const logBox = document.getElementById('publicLogBox');
        logBox.innerHTML = '';
        const regEvents = await contract.queryFilter(
          contract.filters.VoterRegistered()
        );
        const voteEvents = await contract.queryFilter(
          contract.filters.VoteCast()
        );
        const allEvents = [...regEvents, ...voteEvents].sort(
          (a, b) => a.blockNumber - b.blockNumber
        );
        for (const event of allEvents) {
          if (event.fragment.name === 'VoterRegistered') {
            addLogEntry(
              logBox,
              `üë§ REGISTER: ${event.args[1]} (${event.args[0].substring(
                0,
                6
              )}...)`
            );
          } else if (event.fragment.name === 'VoteCast') {
            addLogEntry(
              logBox,
              `üó≥Ô∏è VOTE CAST: Wallet ${event.args[0].substring(0, 6)}...`
            );
          }
        }
        if (allEvents.length === 0)
          addLogEntry(logBox, 'No activity recorded.');
      }

      function addLogEntry(box, message) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span style="color:#5eead4;">[VERIFIED]</span> ${message}`;
        box.prepend(div);
      }

      async function checkAdmin(addr) {
        const owner = await contract.electionCommission();
        if (owner.toLowerCase() === addr.toLowerCase())
          document.getElementById('adminLink').style.display = 'inline-block';
      }

      function showToast(msg) {
        const x = document.getElementById('toast');
        x.innerText = msg;
        x.className = 'show';
        setTimeout(() => (x.className = x.className.replace('show', '')), 3000);
      }

      init();
    </script>
  </body>
</html>
