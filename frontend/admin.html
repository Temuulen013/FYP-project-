<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Portal | SecureVote</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #2563eb;
        --danger: #ef4444;
        --success: #10b981;
        --dark: #0f172a;
      }
      body {
        font-family: 'Inter', sans-serif;
        background: #f1f5f9;
        margin: 0;
        padding-bottom: 50px;
      }

      .header {
        background: var(--dark);
        color: white;
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-weight: 800;
        font-size: 1.2rem;
      }
      .back-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .back-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .container {
        max-width: 1000px;
        margin: 30px auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .full-width {
        grid-column: span 2;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
        color: #334155;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-group {
        display: flex;
        gap: 10px;
      }
      .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        color: white;
        transition: 0.2s;
      }
      .btn-start {
        background: var(--success);
      }
      .btn-start:hover {
        background: #059669;
      }
      .btn-end {
        background: var(--danger);
      }
      .btn-end:hover {
        background: #dc2626;
      }
      .btn-add {
        background: var(--primary);
      }
      .btn-add:hover {
        background: #1e40af;
      }

      input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        box-sizing: border-box;
      }
      label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 5px;
      }

      /* Terminal Style */
      .terminal {
        background: #1e293b;
        color: #38bdf8;
        font-family: monospace;
        border-radius: 12px;
        padding: 20px;
        height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse;
      }
      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #334155;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">üîí Admin Command Center</div>
      <a href="index.html" class="back-btn">‚¨Ö Dashboard</a>
    </div>

    <div class="container">
      <div class="card full-width">
        <h2>‚öôÔ∏è Election Controls</h2>
        <div class="control-group">
          <button class="btn btn-start" onclick="startElection()">
            üü¢ Start Election
          </button>
          <button class="btn btn-end" onclick="endElection()">
            üî¥ End Election
          </button>
        </div>
      </div>

      <div class="card">
        <h2>üë§ Add Candidate</h2>
        <label>Name</label>
        <input type="text" id="cName" placeholder="Candidate Name" />
        <label>Photo URL</label>
        <input type="text" id="cPhoto" placeholder="https://..." />
        <label>Bio</label>
        <input type="text" id="cBio" placeholder="Manifesto..." />
        <button class="btn btn-add" onclick="addCandidate()">
          + Add to Ballot
        </button>
      </div>

      <div class="card terminal-card" style="background: #0f172a; border: none">
        <h2 style="color: white; border-color: #334155">
          üì° Live Blockchain Feed
        </h2>
        <div id="adminLog" class="terminal">
          <div style="color: gray">Waiting for network activity...</div>
        </div>
      </div>
    </div>

    <script>
      // --- ADMIN SCRIPT ---
      let contract, signer;
      const jsonUrl = './Voting.json?t=' + Date.now();

      async function init() {
        if (!window.ethereum) return alert('Install MetaMask');
        const provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const res = await fetch(jsonUrl);
        const data = await res.json();
        contract = new ethers.Contract(data.address, data.abi, signer);

        const owner = await contract.electionCommission();
        const myAddr = await signer.getAddress();
        if (owner.toLowerCase() !== myAddr.toLowerCase()) {
          alert('‚õî ACCESS DENIED');
          window.location.href = 'index.html';
          return;
        }

        // Load History
        loadAuditHistory();
        setupLiveEvents();
      }

      async function startElection() {
        try {
          await (await contract.startElection()).wait();
          alert('‚úÖ Started!');
        } catch (e) {
          alert(e.reason);
        }
      }
      async function endElection() {
        try {
          await (await contract.endElection()).wait();
          alert('üî¥ Ended!');
        } catch (e) {
          alert(e.reason);
        }
      }
      async function addCandidate() {
        try {
          const n = document.getElementById('cName').value;
          const p = document.getElementById('cPhoto').value;
          const b = document.getElementById('cBio').value;
          await (await contract.addCandidate(n, p, b)).wait();
          alert('‚úÖ Added!');
          document.getElementById('cName').value = '';
        } catch (e) {
          alert(e.reason);
        }
      }

      async function loadAuditHistory() {
        const box = document.getElementById('adminLog');
        box.innerHTML = '';
        const regEvents = await contract.queryFilter(
          contract.filters.VoterRegistered()
        );
        const voteEvents = await contract.queryFilter(
          contract.filters.VoteCast()
        );
        const allEvents = [...regEvents, ...voteEvents].sort(
          (a, b) => a.blockNumber - b.blockNumber
        );

        for (const event of allEvents) {
          if (event.fragment.name === 'VoterRegistered')
            log(box, `üë§ REGISTER: ${event.args[1]}`);
          else if (event.fragment.name === 'VoteCast')
            log(box, `üó≥Ô∏è VOTE: ${event.args[0].substring(0, 6)}...`);
        }
      }

      function setupLiveEvents() {
        const box = document.getElementById('adminLog');
        contract.on('VoterRegistered', (v, n) => log(box, `üë§ NEW: ${n}`));
        contract.on('VoteCast', (v) =>
          log(box, `üó≥Ô∏è NEW VOTE: ${v.substring(0, 6)}...`)
        );
      }

      function log(box, msg) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span style="color:#22d3ee;">></span> ${msg}`;
        box.prepend(div);
      }

      init();
    </script>
  </body>
</html>
